class Message {
private:
    string payload;
    time_t timestamp;

public:
    Message(const string& payload) : payload(payload) {
        timestamp = time(NULL);
    }

    string getPayload() const {
        return payload;
    }

    string toString() const {
        return "Message{payload='" + payload + "'}";
    }
};








class Topic {
private:
    string name;
    vector<Subscriber*> subscribers;

public:
    Topic(const string& name) : name(name) {}

    string getName() const {
        return name;
    }

    void addSubscriber(Subscriber* subscriber) {
        // Check if subscriber is already added to avoid duplicates
        for (const auto& sub : subscribers) {
            if (sub->getId() == subscriber->getId()) {
                return; // Already subscribed
            }
        }
        subscribers.push_back(subscriber);
    }

    void removeSubscriber(Subscriber* subscriber) {
        auto it = subscribers.begin();
        while (it != subscribers.end()) {
            if ((*it)->getId() == subscriber->getId()) {
                it = subscribers.erase(it);
            } else {
                ++it;
            }
        }
    }

    void broadcast(const Message& message) {
        for (auto& subscriber : subscribers) {
            try {
                subscriber->onMessage(message);
            } catch (const exception& e) {
                cerr << "Error delivering message to subscriber " << subscriber->getId() 
                     << ": " << e.what() << endl;
            }
        }
    }
};






class AlertSubscriber : public Subscriber {
private:
    string id;

public:
    AlertSubscriber(const string& id) : id(id) {}

    string getId() const {
        return id;
    }

    void onMessage(const Message& message) {
        printf("!!! [ALERT - %s] : '%s' !!!\n", id.c_str(), message.getPayload().c_str());
    }
};







class NewsSubscriber : public Subscriber {
private:
    string id;

public:
    NewsSubscriber(const string& id) : id(id) {}

    string getId() const {
        return id;
    }

    void onMessage(const Message& message) {
        printf("[Subscriber %s] received message '%s'\n", id.c_str(), message.getPayload().c_str());
    }
};





class Subscriber {
public:
    virtual ~Subscriber() {}
    virtual string getId() const = 0;
    virtual void onMessage(const Message& message) = 0;
};







int main() {
    PubSubService* pubSubService = PubSubService::getInstance();

    // --- Create Subscribers ---
    NewsSubscriber sportsFan1("SportsFan1");
    NewsSubscriber sportsFan2("SportsFan2");
    NewsSubscriber techie1("Techie1");
    NewsSubscriber allNewsReader("AllNewsReader");
    AlertSubscriber systemAdmin("SystemAdmin");

    // --- Create Topics and Subscriptions ---
    const string SPORTS_TOPIC = "SPORTS";
    const string TECH_TOPIC = "TECH";
    const string WEATHER_TOPIC = "WEATHER";

    pubSubService->createTopic(SPORTS_TOPIC);
    pubSubService->createTopic(TECH_TOPIC);
    pubSubService->createTopic(WEATHER_TOPIC);

    pubSubService->subscribe(SPORTS_TOPIC, &sportsFan1);
    pubSubService->subscribe(SPORTS_TOPIC, &sportsFan2);
    pubSubService->subscribe(SPORTS_TOPIC, &allNewsReader);
    pubSubService->subscribe(SPORTS_TOPIC, &systemAdmin);

    pubSubService->subscribe(TECH_TOPIC, &techie1);
    pubSubService->subscribe(TECH_TOPIC, &allNewsReader);

    cout << "\n--- Publishing Messages ---" << endl;

    // --- Publish to SPORTS topic ---
    pubSubService->publish(SPORTS_TOPIC, Message("Team A wins the championship!"));
    // Expected: SportsFan1, SportsFan2, AllNewsReader, SystemAdmin receive this.

    cout << endl;

    // --- Publish to TECH topic ---
    pubSubService->publish(TECH_TOPIC, Message("New AI model released."));
    // Expected: Techie1, AllNewsReader receive this.

    cout << endl;

    // --- Publish to WEATHER topic (no subscribers) ---
    pubSubService->publish(WEATHER_TOPIC, Message("Sunny with a high of 75Â°F."));
    // Expected: Message is published but no output since no subscribers.

    cout << "\n--- Unsubscribing a user and re-publishing ---" << endl;

    // SportsFan2 gets tired of sports news
    pubSubService->unsubscribe(SPORTS_TOPIC, &sportsFan2);

    // Publish another message to SPORTS
    pubSubService->publish(SPORTS_TOPIC, Message("Major player traded to Team B."));
    // Expected: SportsFan1, AllNewsReader, SystemAdmin receive this. SportsFan2 does NOT.

    cout << endl;

    // --- Shutdown the service ---
    pubSubService->shutdown();

    return 0;
}










class PubSubService {
private:
    static PubSubService* instance;
    unordered_map<string, Topic*> topicRegistry;

    PubSubService() {}

public:
    static PubSubService* getInstance() {
        if (instance == NULL) {
            instance = new PubSubService();
        }
        return instance;
    }

    void createTopic(const string& topicName) {
        if (topicRegistry.find(topicName) == topicRegistry.end()) {
            topicRegistry[topicName] = new Topic(topicName);
        }
        cout << "Topic " << topicName << " created" << endl;
    }

    void subscribe(const string& topicName, Subscriber* subscriber) {
        auto it = topicRegistry.find(topicName);
        if (it == topicRegistry.end()) {
            throw invalid_argument("Topic not found: " + topicName);
        }
        it->second->addSubscriber(subscriber);
        cout << "Subscriber '" << subscriber->getId() << "' subscribed to topic: " << topicName << endl;
    }

    void unsubscribe(const string& topicName, Subscriber* subscriber) {
        auto it = topicRegistry.find(topicName);
        if (it != topicRegistry.end()) {
            it->second->removeSubscriber(subscriber);
        }
        cout << "Subscriber '" << subscriber->getId() << "' unsubscribed from topic: " << topicName << endl;
    }

    void publish(const string& topicName, const Message& message) {
        cout << "Publishing message to topic: " << topicName << endl;
        auto it = topicRegistry.find(topicName);
        if (it == topicRegistry.end()) {
            throw invalid_argument("Topic not found: " + topicName);
        }
        it->second->broadcast(message);
    }

    void shutdown() {
        cout << "PubSubService shutting down..." << endl;
        
        // Clean up topics
        for (auto& pair : topicRegistry) {
            delete pair.second;
        }
        topicRegistry.clear();
        
        cout << "PubSubService shutdown complete." << endl;
    }

    ~PubSubService() {
        shutdown();
    }
};

PubSubService* PubSubService::instance = NULL;



















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































