

class RetryableGatewayDecorator(NotificationGateway):
    def __init__(self, wrapped_gateway: NotificationGateway, max_retries: int, retry_delay_millis: int):
        self.wrapped_gateway = wrapped_gateway
        self.max_retries = max_retries
        self.retry_delay_millis = retry_delay_millis

    def send(self, notification: Notification):
        attempt = 0
        while attempt < self.max_retries:
            try:
                self.wrapped_gateway.send(notification)
                return  # Success
            except Exception as e:
                attempt += 1
                print(f"Error: Attempt {attempt} failed for notification {notification.get_id()}. Retrying...")
                if attempt >= self.max_retries:
                    print(str(e))
                    raise Exception(f"Failed to send notification after {self.max_retries} attempts.") from e
                time.sleep(self.retry_delay_millis / 1000.0)







class Notification:
    def __init__(self, builder):
        self.id = str(uuid.uuid4())
        self.recipient = builder.recipient
        self.type = builder.type
        self.message = builder._message
        self.subject = builder._subject

    def get_id(self) -> str:
        return self.id

    def get_recipient(self) -> Recipient:
        return self.recipient

    def get_type(self) -> NotificationType:
        return self.type

    def get_message(self) -> str:
        return self.message

    def get_subject(self) -> str:
        return self.subject

    class Builder:
        def __init__(self, recipient: Recipient, notification_type: NotificationType):
            self.recipient = recipient
            self.type = notification_type
            self._message = None
            self._subject = None

        def message(self, message: str):
            self._message = message
            return self

        def subject(self, subject: str):
            self._subject = subject
            return self

        def build(self):
            return Notification(self)

























class Recipient:
    def __init__(self, user_id: str, email: Optional[str] = None, phone_number: Optional[str] = None, push_token: Optional[str] = None):
        self.user_id = user_id
        self.email = email
        self.phone_number = phone_number
        self.push_token = push_token

    def get_user_id(self) -> str:
        return self.user_id

    def get_email(self) -> Optional[str]:
        return self.email

    def get_phone_number(self) -> Optional[str]:
        return self.phone_number

    def get_push_token(self) -> Optional[str]:
        return self.push_token















class NotificationType(Enum):
    EMAIL = "EMAIL"
    SMS = "SMS"
    PUSH = "PUSH"













class NotificationFactory:
    _gateway_map: Dict[NotificationType, NotificationGateway] = {}

    @classmethod
    def create_gateway(cls, notification_type: NotificationType) -> NotificationGateway:
        if notification_type in cls._gateway_map:
            return cls._gateway_map[notification_type]

        gateway = None

        if notification_type == NotificationType.EMAIL:
            gateway = EmailGateway()
        elif notification_type == NotificationType.SMS:
            gateway = SmsGateway()
        elif notification_type == NotificationType.PUSH:
            gateway = PushGateway()

        cls._gateway_map[notification_type] = gateway
        return gateway










class EmailGateway(NotificationGateway):
    def send(self, notification: Notification):
        email = notification.get_recipient().get_email()
        if email is None:
            raise ValueError("Email address is required for EMAIL notification.")
        
        print("--- Sending EMAIL ---")
        print(f"To: {email}")
        print(f"Subject: {notification.get_subject()}")
        print(f"Body: {notification.get_message()}")
        print("---------------------\n")







class NotificationGateway(ABC):
    @abstractmethod
    def send(self, notification: Notification):
        pass












class PushGateway(NotificationGateway):
    def send(self, notification: Notification):
        token = notification.get_recipient().get_push_token()
        if token is None:
            raise ValueError("Push token is required for PUSH notification.")
        
        print("--- Sending PUSH Notification ---")
        print(f"To Device Token: {token}")
        print(f"Title: {notification.get_subject()}")
        print(f"Body: {notification.get_message()}")
        print("---------------------------------\n")










class SmsGateway(NotificationGateway):
    def send(self, notification: Notification):
        phone = notification.get_recipient().get_phone_number()
        if phone is None:
            raise ValueError("Phone number is required for SMS notification.")
        
        print("--- Sending SMS ---")
        print(f"To: {phone}")
        print(f"Message: {notification.get_message()}")
        print("-------------------\n")








class NotificationService:
    def __init__(self, pool_size: int):
        self.executor = ThreadPoolExecutor(max_workers=pool_size)

    def send_notification(self, notification: Notification):
        def send_task():
            gateway = RetryableGatewayDecorator(
                NotificationFactory.create_gateway(notification.get_type()),
                3,
                1000
            )
            try:
                gateway.send(notification)
            except Exception as e:
                print(f"Exception while sending notification: {e}")

        self.executor.submit(send_task)

    def shutdown(self):
        self.executor.shutdown()



















def main():
    # 1. Setup the notification service
    notification_service = NotificationService(10)

    # 2. Define recipients
    recipient1 = Recipient("user123", "john.doe@example.com", None, "pushToken123")
    recipient2 = Recipient("user456", None, "+15551234567", None)

    # 3. Send various notifications using the Facade (NotificationService)

    # Scenario 1: Send a welcome email
    welcome_email = (Notification.Builder(recipient1, NotificationType.EMAIL)
                     .subject("Welcome!")
                     .message("Welcome to notification system")
                     .build())
    notification_service.send_notification(welcome_email)

    # Scenario 2: Send a direct push notification
    push_notification = (Notification.Builder(recipient1, NotificationType.PUSH)
                        .subject("New Message")
                        .message("You have a new message from Jane.")
                        .build())
    notification_service.send_notification(push_notification)

    # Scenario 3: Send order confirmation SMS
    order_sms = (Notification.Builder(recipient2, NotificationType.SMS)
                .message("Your order for Digital Clock is confirmed")
                .build())
    notification_service.send_notification(order_sms)

    # Wait for a moment to allow the queue processor to work
    time.sleep(1)

    # 4. Shutdown the system
    print("\nShutting down the notification system...")
    notification_service.shutdown()
    print("System shut down successfully.")

if __name__ == "__main__":
    main()


























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































